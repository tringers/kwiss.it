class t{qtid=[];qtname=[];qtdescription=[];addQuestionType(t,e,n){this.qtid.push(t),this.qtname.push(e),this.qtdescription.push(n)}getQuestionType(e){for(let t=0;t<this.qtid.length;t++)if(this.qtid[t]===e)return{name:this.qtname[t],description:this.qtdescription[t]}}}const s=document.getElementById("lobby-data").getAttribute("data-lobby-key"),e=document.getElementById("lobby-data").getAttribute("data-auth-token"),i=document.getElementById("crypto"),a=document.getElementById("question-data"),d=document.getElementById("answer-data"),r=new TextEncoder,o=new TextDecoder,n=document.getElementById("btnReady"),u=document.getElementById("playeramount");let c="",l=0,b={meta:{maxQuestions:0,timeStarted:0,timePerQuestion:20,qTypes:new t},interval:null,processedQuestion:-1,lastSubmitted:!1,scoresFetched:!1,gamedata:{lastSubmissionCorrect:!1,streak:1,score:0,addition:0}};const m={lastSubmissionCorrect:!1,streak:1,score:0,addition:0};function h(t){fetch("/lobby/ready/"+s+"/"+t.toString())}if(n.addEventListener("click",()=>{switch(parseInt(n.getAttribute("data-value"))){case 0:n.value="Nicht bereit",n.setAttribute("data-value","1"),h(!0);break;case 1:n.value="Bereit",n.setAttribute("data-value","0"),h(!1)}}),0===parseInt(i.getAttribute("data-iv"))){let t=crypto.getRandomValues(new Uint8Array(16)),e=t.join(",");i.setAttribute("data-iv",e)}function y(){let t=i.getAttribute("data-iv");var e=t.split(","),n=new ArrayBuffer(16);let a=new Uint8Array(n);for(let t=0;t<e.length;t++)a[t]=parseInt(e[t]);return n}async function p(t,e){var n=r.encode(t),t=r.encode(e),e=await crypto.subtle.digest("SHA-256",t),t={name:"AES-GCM",iv:y()},e=await crypto.subtle.importKey("raw",e,t,!1,["encrypt"]);return f(await crypto.subtle.encrypt(t,e,n))}async function g(t,e){var n=r.encode(e),e=await crypto.subtle.digest("SHA-256",n),n={name:"AES-GCM",iv:y()},e=await crypto.subtle.importKey("raw",e,n,!1,["decrypt"]),t=w(t),t=await crypto.subtle.decrypt(n,e,t);return o.decode(t)}function f(t){let e="";var n=new Uint8Array(t),a=n.byteLength;for(let t=0;t<a;t++)e+=String.fromCharCode(n[t]);return window.btoa(e)}function w(t){let e=window.atob(t);var n=e.length;let a=new Uint8Array(n);for(let t=0;t<n;t++)a[t]=e.charCodeAt(t);return a.buffer}let A=setInterval(()=>{fetch("/lobby/heartbeat/"+s).then(t=>{l=0,t.json().then(t=>{if(200===parseInt(t.status))""===c&&(c=t.name,b.playerScores={},b.playerScores[c]=Object.assign({},m));else{let t=document.getElementById("lobby-error"),e=document.getElementById("lobby-error-content");e.innerHTML="Verbindung unterbrochen. Zu lange keine Verbindung zur Lobby beibehalten. Leite zurÃ¼ck zur Lobbyliste.",t.hidden=!1,t.classList.remove("invisible"),setTimeout(()=>{window.location.href=base_url+"/lobbylist"},5e3)}})}).catch(()=>l++),fetch(api_url+"/lobbyuser/?lkey="+s).then(t=>t.json().then(i=>{const r=document.getElementById("table-body");let s=!1;u.innerHTML=i.length;let d=!0;for(let a=0;a<i.length;a++){var o=i[a],l=o.first_name,o=o.LPready;o||(d=!1);let t=document.createElement("tr"),e=document.createElement("td"),n=document.createElement("td");e.innerHTML=l,n.innerHTML=o?"Bereit":"Nicht bereit",l===c?t.classList.add("table-info"):o?t.classList.add("table-success"):t.classList.add("table-danger"),n.classList.add("text-center"),t.appendChild(e),t.appendChild(n),s||(r.innerHTML="",s=!0),r.appendChild(t)}d&&(n.disabled=!0,prepGame())}))},250);function q(){clearInterval(A)}function v(){fetch(api_url+"/lobbydata/?lkey="+s).then(t=>t.json().then(t=>{t.length<1||(t=t[0],b.meta.timePerQuestion=parseInt(t.Ltimeamount))}))}function L(){fetch(api_url+"/questiontype/").then(t=>t.json().then(e=>{for(let t=0;t<e.length;t++)b.meta.qTypes.addQuestionType(parseInt(e[t].QTid),e[t].QTname,e[t].QTdescription)})),fetch(api_url+"/lobbyquestions/?lkey="+s).then(t=>t.json().then(t=>{b.meta.maxQuestions=t.length;for(let r=0;r<t.length;r++){let i=t[r].Qid;fetch(api_url+"/question/?qid="+i).then(t=>t.json().then(n=>{p(n[0].Qtext,s).then(t=>{let e=document.createElement("meta");e.id="question-"+r,e.classList.add("question-data"),e.setAttribute("data-qid",i),e.setAttribute("data-cid",n[0].Cid),e.setAttribute("data-cname",n[0].Cname),e.setAttribute("data-qtext",t),e.setAttribute("data-qtype",n[0].QTid),a.appendChild(e),fetch(api_url+"/answer/?qid="+i).then(t=>t.json().then(a=>{for(let n=0;n<a.length;n++)p(a[n].Atext,s).then(t=>{let e=document.createElement("meta");e.id="answer-"+r+"-"+n,e.classList.add("answer-data"),e.classList.add("answer-question-"+r),e.setAttribute("data-qid",i),e.setAttribute("data-anum",a[n].Anum),e.setAttribute("data-atext",t),d.appendChild(e)})}))})}))}}))}setTimeout(v,1e3),setTimeout(L,2e3);