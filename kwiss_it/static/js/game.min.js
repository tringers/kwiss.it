const e=document.getElementById("lobby"),t=document.getElementById("game"),n=document.getElementById("qHeader"),o=document.getElementById("qhCategory"),c=document.getElementById("qhCurrentQuestion"),a=document.getElementById("qhMaxQuestion"),u=document.getElementById("qhQuestion"),g=document.getElementById("qhType"),y=document.getElementById("timeBar"),s=document.getElementById("submitAnswer"),d=document.getElementById("answers"),r=document.getElementById("qResult");let i=!1,p=!1;function m(){if(a.innerHTML=game.meta.maxQuestions,0===game.meta.timeStarted){stopHeartbeat(),heartbeat=setInterval(T,100);for(let t=0;t<6;t++)setTimeout(()=>{let e=document.getElementById("lobbyDelayTime");e.innerHTML="Start in "+(5-t)+"s",5===t&&L()},1e3*(t+1))}}function l(){return(new Date).valueOf()}function b(){return Math.floor(l()/1e3)}function L(){e.classList.add("invisible"),e.hidden=!0,t.classList.remove("invisible"),t.hidden=!1,game.meta.timeStarted=b(),game.interval=setInterval(h,50)}function h(){var e=E();e!==game.processedQuestion||H()||(game.lastSubmitted||(game.lastSubmitted=!0,_([-1])),game.scoresFetched||(game.scoresFetched=!0,setTimeout(S,3e3))),e!==game.processedQuestion&&e<game.meta.maxQuestions&&(w(),game.processedQuestion=e,f(),game.gamedata[first_name].lastSubmissionCorrect=!1,game.lastSubmitted=!1,s.disabled=!1,game.scoresFetched=!1),e+1!==game.meta.maxQuestions||H()?y.style.width=Math.round(100-100*I()/game.meta.timePerQuestion)+"%":(clearInterval(game.interval),clearInterval(heartbeat),i||(i=!0,setTimeout(k,1e4)))}async function T(){await fetch("/lobby/heartbeat/"+lobby_key)}async function f(){var e=E();let t=document.getElementById("question-"+e);var n=t.getAttribute("data-cname"),a=t.getAttribute("data-qtext"),a=await decrypt(a,lobby_key),s=t.getAttribute("data-qtype");let r=document.getElementsByClassName("answer-question-"+e),i=[];for(let e=0;e<r.length;e++){var m=r[e].getAttribute("data-anum"),l=r[e].getAttribute("data-atext");i.push({anum:parseInt(m),atext:await decrypt(l,lobby_key)})}var d=parseInt(s),s=game.meta.qTypes.getQuestionType(d);o.innerHTML=n,c.innerHTML=(e+1).toString(),u.innerHTML=a,g.innerHTML=s.description,y.style.width=Math.round(100-100*I()/game.meta.timePerQuestion)+"%",v(d,i)}function v(n,s){switch(n){case 1:d.innerHTML="";let e=document.getElementById("qtype_temp1").cloneNode(!0);e.id="qtype_1_1",e.classList.remove("template"),e.innerHTML=e.innerHTML.replaceAll("temp1","1_1"),d.appendChild(e);break;case 2:d.innerHTML="";for(let a=0;a<s.length;a++){var r=s[a].anum,i=s[a].atext;let e=document.getElementById("qtype_temp2").cloneNode(!0);e.id="qtype_2_"+a,e.classList.remove("template"),e.innerHTML=e.innerHTML.replaceAll("temp2","2_"+a),d.appendChild(e);let t=document.getElementById("answer_2_"+a),n=document.getElementById("answerLabel_2_"+a);t.value=r,n.innerHTML=i}break;case 3:d.innerHTML="";for(let a=0;a<s.length;a++){var m=s[a].anum,l=s[a].atext;let e=document.getElementById("qtype_temp3").cloneNode(!0);e.id="qtype_3_"+a,e.classList.remove("template"),e.innerHTML=e.innerHTML.replaceAll("temp3","3_"+a),d.appendChild(e);let t=document.getElementById("answer_3_"+a),n=document.getElementById("answerLabel_3_"+a);t.value=m,n.innerHTML=l}break;case 4:d.innerHTML="";let t=document.getElementById("qtype_temp4").cloneNode(!0);t.id="qtype_4_1",t.classList.remove("template"),t.innerHTML=t.innerHTML.replaceAll("temp4","4_1"),d.appendChild(t)}}async function M(e="",t={}){const n=await fetch(e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json","X-CSRFToken":document.getElementsByName("csrfmiddlewaretoken")[0].value},credentials:"same-origin",redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});return n.json()}function E(){var e=Math.abs(game.meta.timeStarted-b()),t=game.meta.timePerQuestion+15;return Math.floor(e/t)}function H(){var e=Math.abs(game.meta.timeStarted-b()),t=game.meta.timePerQuestion;return e%(game.meta.timePerQuestion+15)<t}function I(){return Math.abs(game.meta.timeStarted+E()*(game.meta.timePerQuestion+15)-b())}function _(e=[-1]){0===e.length&&e.push(-1),M(base_url+"/game/"+lobby_key,{lobbyAuth:lobby_auth,name:first_name,qno:E()+1,answer:e}).then(s=>{if(console.log("Answer: "),console.log(s),!s.checkLater){let e=document.getElementById("myResult");e.classList.remove("text-success"),e.classList.remove("text-danger"),s.lastSubmissionCorrect?(e.classList.add("text-success"),e.innerHTML="Korrekte Antwort!"):(e.classList.add("text-danger"),e.innerHTML="Falsche Antwort!");let t=document.getElementById("myAddition"),n=document.getElementById("myStreak"),a=document.getElementById("myScore");t.innerHTML=s.addition,n.innerHTML=s.streak,a.innerHTML=s.score}})}function B(){var i=Object.keys(game.gamedata);let m=document.getElementById("overallResult");m.innerHTML="";for(let r=0;r<i.length;r++){var l=game.gamedata[i[r]];if(i[r]!==first_name||p)if(i[r]===first_name&&p){let e=document.getElementById("myResult");e.classList.remove("text-success"),e.classList.remove("text-danger"),l.lastSubmissionCorrect?(e.classList.add("text-success"),e.innerHTML="Korrekte Antwort!"):(e.classList.add("text-danger"),e.innerHTML="Falsche Antwort!");let t=document.getElementById("myAddition"),n=document.getElementById("myStreak"),a=document.getElementById("myScore");t.innerHTML=l.addition,n.innerHTML=l.streak,a.innerHTML=l.score}else{let e=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("td"),a=document.createElement("td"),s=document.createElement("td");l.lastSubmissionCorrect?e.classList.add("table-success"):e.classList.add("table-danger"),n.classList.add("text-center"),a.classList.add("text-center"),s.classList.add("text-center"),t.innerHTML=i[r],n.innerHTML=l.addition,a.innerHTML=l.streak,s.innerHTML=l.score,e.appendChild(t),e.appendChild(n),e.appendChild(a),e.appendChild(s),m.appendChild(e)}}d.classList.add("invisible"),r.classList.remove("invisible")}function w(){d.classList.remove("invisible"),r.classList.add("invisible")}function S(){fetch(base_url+"/game/"+lobby_key).then(e=>e.json().then(n=>{console.log("Status: "),console.log(n),p=n.deviation;for(let t=0;t<n.results.length;t++){var a=n.results[t];let e=Object.assign(playerScoreTemplate,game.gamedata[a.name]);e.streak=a.streak,e.score=a.score,e.addition=a.addition,console.log(a.name),console.log(e),game.gamedata[a.name]=e}B()}))}function k(){alert("DONE")}s.addEventListener("click",()=>{if(s.disabled=!0,!game.lastSubmitted){game.lastSubmitted=!0;let t=[],n=document.getElementsByName("answer");for(let e=0;e<n.length;e++)0<=n[e].id.indexOf("answer_temp")||!n[e].checked&&5!==n.length||t.push(n[e].value);_(t)}});