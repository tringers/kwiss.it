const e=document.getElementById("lobby"),t=document.getElementById("game"),n=document.getElementById("qHeader"),u=document.getElementById("qhCategory"),g=document.getElementById("qhCurrentQuestion"),a=document.getElementById("qhMaxQuestion"),y=document.getElementById("qhQuestion"),b=document.getElementById("qhType"),p=document.getElementById("timeBar"),s=document.getElementById("submitAnswer"),l=document.getElementById("answers"),i=document.getElementById("qResult");let r=!1,o=!1;function m(){if(a.innerHTML=game.meta.maxQuestions,0===game.meta.timeStarted){stopHeartbeat(),heartbeat=setInterval(T,100);for(let t=0;t<6;t++)setTimeout(()=>{let e=document.getElementById("lobbyDelayTime");e.innerHTML="Start in "+(5-t)+"s",5===t&&L()},1e3*(t+1))}}function d(){return(new Date).valueOf()}function c(){return Math.floor(d()/1e3)}function L(){e.classList.add("invisible"),e.hidden=!0,t.classList.remove("invisible"),t.hidden=!1,game.meta.timeStarted=c(),game.interval=setInterval(h,50)}function h(){var e=E();e!==game.processedQuestion||H()||(game.lastSubmitted||(game.lastSubmitted=!0,_([-1])),game.scoresFetched||(game.scoresFetched=!0,setTimeout(S,3e3))),e!==game.processedQuestion&&e<game.meta.maxQuestions&&(w(),game.processedQuestion=e,f(),game.gamedata[first_name].lastSubmissionCorrect=!1,game.lastSubmitted=!1,s.disabled=!1,game.scoresFetched=!1,resetVotebutton()),e+1!==game.meta.maxQuestions||H()?p.style.width=Math.round(100-100*I()/game.meta.timePerQuestion)+"%":(clearInterval(game.interval),clearInterval(heartbeat),r||(r=!0,setTimeout(k,1e4)))}async function T(){await fetch("/lobby/heartbeat/"+lobby_key)}async function f(){var e=E();let t=document.getElementById("question-"+e);var n=t.getAttribute("data-cname"),a=t.getAttribute("data-cid"),s=t.getAttribute("data-qtext"),i=t.getAttribute("data-qid"),s=await decrypt(s,lobby_key),r=t.getAttribute("data-qtype");let m=document.getElementsByClassName("answer-question-"+e),d=[];for(let e=0;e<m.length;e++){var l=m[e].getAttribute("data-anum"),o=m[e].getAttribute("data-atext");d.push({anum:parseInt(l),atext:await decrypt(o,lobby_key)})}var c=parseInt(r),r=game.meta.qTypes.getQuestionType(c);u.innerHTML=n,u.setAttribute("data-cid",a),g.innerHTML=(e+1).toString(),y.innerHTML=s,y.setAttribute("data-qid",i),b.innerHTML=r.description,p.style.width=Math.round(100-100*I()/game.meta.timePerQuestion)+"%",v(c,d)}function v(n,s){switch(n){case 1:l.innerHTML="";let e=document.getElementById("qtype_temp1").cloneNode(!0);e.id="qtype_1_1",e.classList.remove("template"),e.innerHTML=e.innerHTML.replaceAll("temp1","1_1"),l.appendChild(e);break;case 2:l.innerHTML="";for(let a=0;a<s.length;a++){var i=s[a].anum,r=s[a].atext;let e=document.getElementById("qtype_temp2").cloneNode(!0);e.id="qtype_2_"+a,e.classList.remove("template"),e.innerHTML=e.innerHTML.replaceAll("temp2","2_"+a),l.appendChild(e);let t=document.getElementById("answer_2_"+a),n=document.getElementById("answerLabel_2_"+a);t.value=i,n.innerHTML=r}break;case 3:l.innerHTML="";for(let a=0;a<s.length;a++){var m=s[a].anum,d=s[a].atext;let e=document.getElementById("qtype_temp3").cloneNode(!0);e.id="qtype_3_"+a,e.classList.remove("template"),e.innerHTML=e.innerHTML.replaceAll("temp3","3_"+a),l.appendChild(e);let t=document.getElementById("answer_3_"+a),n=document.getElementById("answerLabel_3_"+a);t.value=m,n.innerHTML=d}break;case 4:l.innerHTML="";let t=document.getElementById("qtype_temp4").cloneNode(!0);t.id="qtype_4_1",t.classList.remove("template"),t.innerHTML=t.innerHTML.replaceAll("temp4","4_1"),l.appendChild(t)}}async function M(e="",t={}){const n=await fetch(e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json","X-CSRFToken":document.getElementsByName("csrfmiddlewaretoken")[0].value},credentials:"same-origin",redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});return n.json()}function E(){var e=Math.abs(game.meta.timeStarted-c()),t=game.meta.timePerQuestion+15;return Math.floor(e/t)}function H(){var e=Math.abs(game.meta.timeStarted-c()),t=game.meta.timePerQuestion;return e%(game.meta.timePerQuestion+15)<t}function I(){return Math.abs(game.meta.timeStarted+E()*(game.meta.timePerQuestion+15)-c())}function _(e=[-1]){0===e.length&&e.push(-1),M(base_url+"/game/"+lobby_key,{lobbyAuth:lobby_auth,name:first_name,qno:E()+1,answer:e}).then(s=>{if(!s.checkLater){let e=document.getElementById("myResult");e.classList.remove("text-success"),e.classList.remove("text-danger"),s.lastSubmissionCorrect?(e.classList.add("text-success"),e.innerHTML="Korrekte Antwort!"):(e.classList.add("text-danger"),e.innerHTML="Falsche Antwort!");let t=document.getElementById("myAddition"),n=document.getElementById("myStreak"),a=document.getElementById("myScore");t.innerHTML=s.addition,n.innerHTML=s.streak,a.innerHTML=s.score}})}function B(){var r=Object.keys(game.gamedata);let m=document.getElementById("overallResult");m.innerHTML="";for(let i=0;i<r.length;i++){var d=game.gamedata[r[i]];if(r[i]!==first_name||o)if(r[i]===first_name&&o){let e=document.getElementById("myResult");e.classList.remove("text-success"),e.classList.remove("text-danger"),d.lastSubmissionCorrect?(e.classList.add("text-success"),e.innerHTML="Korrekte Antwort!"):(e.classList.add("text-danger"),e.innerHTML="Falsche Antwort!");let t=document.getElementById("myAddition"),n=document.getElementById("myStreak"),a=document.getElementById("myScore");t.innerHTML=d.addition,n.innerHTML=d.streak,a.innerHTML=d.score}else{let e=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("td"),a=document.createElement("td"),s=document.createElement("td");d.lastSubmissionCorrect?e.classList.add("table-success"):e.classList.add("table-danger"),n.classList.add("text-center"),a.classList.add("text-center"),s.classList.add("text-center"),t.innerHTML=r[i],n.innerHTML=d.addition,a.innerHTML=d.streak,s.innerHTML=d.score,e.appendChild(t),e.appendChild(n),e.appendChild(a),e.appendChild(s),m.appendChild(e)}}l.classList.add("invisible"),i.classList.remove("invisible")}function w(){l.classList.remove("invisible"),i.classList.add("invisible")}function S(){fetch(base_url+"/game/"+lobby_key).then(e=>e.json().then(n=>{o=n.deviation;for(let t=0;t<n.results.length;t++){var a=n.results[t];let e=Object.assign(playerScoreTemplate,game.gamedata[a.name]);e.streak=a.streak,e.score=a.score,e.addition=a.addition,game.gamedata[a.name]=e}B()}))}function k(){alert("DONE")}s.addEventListener("click",()=>{if(s.disabled=!0,!game.lastSubmitted){game.lastSubmitted=!0;let t=[],n=document.getElementsByName("answer");for(let e=0;e<n.length;e++)0<=n[e].id.indexOf("answer_temp")||!n[e].checked&&5!==n.length||t.push(n[e].value);_(t)}});