const e=document.getElementById("lobby"),t=document.getElementById("game"),n=document.getElementById("qHeader"),o=document.getElementById("qhCategory"),c=document.getElementById("qhCurrentQuestion"),a=document.getElementById("qhMaxQuestion"),u=document.getElementById("qhQuestion"),g=document.getElementById("qhType"),y=document.getElementById("timeBar"),s=document.getElementById("submitAnswer"),l=document.getElementById("answers"),m=document.getElementById("qResult");function r(){if(a.innerHTML=game.meta.maxQuestions,0===game.meta.timeStarted){stopHeartbeat(),heartbeat=setInterval(h,100);for(let t=0;t<6;t++)setTimeout(()=>{let e=document.getElementById("lobbyDelayTime");e.innerHTML="Start in "+(5-t)+"s",5===t&&p()},1e3*(t+1))}}function i(){return(new Date).valueOf()}function d(){return Math.floor(i()/1e3)}function p(){e.classList.add("invisible"),e.hidden=!0,t.classList.remove("invisible"),t.hidden=!1,game.meta.timeStarted=d(),game.interval=setInterval(b,50)}function b(){var e=E();e!==game.processedQuestion||T()||(game.lastSubmitted||(game.lastSubmitted=!0,M([-1])),game.scoresFetched||(game.scoresFetched=!0,setTimeout(H,3e3))),e!==game.processedQuestion&&e<game.meta.maxQuestions&&(I(),game.processedQuestion=e,L(),game.gamedata[first_name].lastSubmissionCorrect=!1,game.lastSubmitted=!1,s.disabled=!1,game.scoresFetched=!1),y.style.width=Math.round(100-100*_()/game.meta.timePerQuestion)+"%"}async function h(){await fetch("/lobby/heartbeat/"+lobby_key)}async function L(){var e=E();let t=document.getElementById("question-"+e);var n=t.getAttribute("data-cname"),a=t.getAttribute("data-qtext"),a=await decrypt(a,lobby_key),s=t.getAttribute("data-qtype");let m=document.getElementsByClassName("answer-question-"+e),r=[];for(let e=0;e<m.length;e++){var i=m[e].getAttribute("data-anum"),d=m[e].getAttribute("data-atext");r.push({anum:parseInt(i),atext:await decrypt(d,lobby_key)})}var l=parseInt(s),s=game.meta.qTypes.getQuestionType(l);o.innerHTML=n,c.innerHTML=(e+1).toString(),u.innerHTML=a,g.innerHTML=s.description,y.style.width=Math.round(100-100*_()/game.meta.timePerQuestion)+"%",f(l,r)}function f(n,s){switch(n){case 1:l.innerHTML="";let e=document.getElementById("qtype_temp1").cloneNode(!0);e.id="qtype_1_1",e.classList.remove("template"),e.innerHTML.replace("temp1","1_1"),l.appendChild(e);break;case 2:l.innerHTML="";for(let a=0;a<s.length;a++){var m=s[a].anum,r=s[a].atext;let e=document.getElementById("qtype_temp2").cloneNode(!0);e.id="qtype_2_"+a,e.classList.remove("template"),e.innerHTML.replace("temp2","2_"+a),l.appendChild(e);let t=document.getElementById("answer_2_"+a),n=document.getElementById("answerLabel_2_"+a);t.value=m,n.innerHTML=r}break;case 3:l.innerHTML="";for(let a=0;a<s.length;a++){var i=s[a].anum,d=s[a].atext;let e=document.getElementById("qtype_temp3").cloneNode(!0);e.id="qtype_3_"+a,e.classList.remove("template"),e.innerHTML.replace("temp3","3_"+a),l.appendChild(e);let t=document.getElementById("answer_3_"+a),n=document.getElementById("answerLabel_3_"+a);t.value=i,n.innerHTML=d}break;case 4:l.innerHTML="";let t=document.getElementById("qtype_temp4").cloneNode(!0);t.id="qtype_4_1",t.classList.remove("template"),t.innerHTML.replace("temp4","4_1"),l.appendChild(t)}}async function v(e="",t={}){const n=await fetch(e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json","X-CSRFToken":document.getElementsByName("csrfmiddlewaretoken")[0].value},credentials:"same-origin",redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});return n.json()}function E(){var e=Math.abs(game.meta.timeStarted-d()),t=game.meta.timePerQuestion+15;return Math.floor(e/t)}function T(){var e=Math.abs(game.meta.timeStarted-d()),t=game.meta.timePerQuestion;return e%(game.meta.timePerQuestion+15)<t}function _(){return Math.abs(game.meta.timeStarted+E()*(game.meta.timePerQuestion+15)-d())}function M(e=[-1]){v(base_url+"/game/"+lobby_key,{lobbyAuth:lobby_auth,name:first_name,qno:E()+1,answer:e}).then(s=>{if(!s.checkLater){let e=document.getElementById("myResult");e.classList.remove("text-success"),e.classList.remove("text-danger"),s.lastSubmissionCorrect?(e.classList.add("text-success"),e.innerHTML="Korrekte Antwort!"):(e.classList.add("text-danger"),e.innerHTML="Falsche Antwort!");let t=document.getElementById("myAddition"),n=document.getElementById("myStreak"),a=document.getElementById("myScore");t.innerHTML=s.addition,n.innerHTML=s.streak,a.innerHTML=s.score}})}function B(){var r=Object.keys(game.gamedata);let i=document.getElementById("overallResult");i.innerHTML="";for(let m=0;m<r.length;m++)if(r[m]!==first_name){var d=game.gamedata[r[m]];let e=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("td"),a=document.createElement("td"),s=document.createElement("td");d.lastSubmissionCorrect?e.classList.add("table-success"):e.classList.add("table-danger"),n.classList.add("text-center"),a.classList.add("text-center"),s.classList.add("text-center"),t.innerHTML=r[m],n.innerHTML=d.addition,a.innerHTML=d.streak,s.innerHTML=d.score,e.appendChild(t),e.appendChild(n),e.appendChild(a),e.appendChild(s),i.appendChild(e)}l.classList.add("invisible"),m.classList.remove("invisible")}function I(){l.classList.remove("invisible"),m.classList.add("invisible")}function H(){fetch(base_url+"/game/"+lobby_key).then(e=>e.json().then(n=>{for(let t=0;t<n.length;t++){var a=n[t];let e=Object.assign(playerScoreTemplate,game.playerScores[a.name]);e.streak=a.streak,e.score=a.score,e.addition=a.addition,game.playerScores[a.name]=e}B()}))}s.addEventListener("click",()=>{if(s.disabled=!0,!game.lastSubmitted){game.lastSubmitted=!0;let t=[];var n=document.getElementsByName("answer");for(let e=0;e<n;e++)!n.checked&&1!==n.length||t.push(n.value);M(t)}});