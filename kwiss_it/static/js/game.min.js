const e=document.getElementById("lobby"),t=document.getElementById("game"),n=document.getElementById("qHeader"),o=document.getElementById("qhCategory"),c=document.getElementById("qhCurrentQuestion"),a=document.getElementById("qhMaxQuestion"),u=document.getElementById("qhQuestion"),g=document.getElementById("qhType"),y=document.getElementById("timeBar"),s=document.getElementById("submitAnswer"),l=document.getElementById("answers"),r=document.getElementById("qResult");function i(){if(a.innerHTML=game.meta.maxQuestions,0===game.meta.timeStarted){stopHeartbeat(),game.interval=setInterval(gameTick,50);for(let t=0;t<6;t++)setTimeout(()=>{let e=document.getElementById("lobbyDelayTime");e.innerHTML="Start in "+(5-t)+"s",5===t&&p()},1e3*(t+1))}}function m(){return(new Date).valueOf()}function d(){return Math.floor(m()/1e3)}function p(){e.classList.add("invisible"),e.hidden=!0,t.classList.remove("invisible"),t.hidden=!1,game.meta.timeStarted=d(),game.interval=setInterval(b,50)}function b(){h();var e=T();e!==game.processedQuestion||E()||(game.lastSubmitted||(game.lastSubmitted=!0,_([-1])),game.scoresFetched||(game.scoresFetched=!0,setTimeout(H,5e3))),e!==game.processedQuestion&&(B(),game.processedQuestion=e,L(),game.gamedata[first_name].lastSubmissionCorrect=!1,game.lastSubmitted=!1,s.disabled=!1,game.scoresFetched=!1),y.style.width=Math.round(100-100*M()/game.meta.timePerQuestion)+"%"}async function h(){}async function L(){var e=T();let t=document.getElementById("question-"+e);var n=t.getAttribute("data-cname"),a=t.getAttribute("data-qtext"),a=await decrypt(a,lobby_key),s=t.getAttribute("data-qtype");let r=document.getElementsByClassName("answer-question-"+e),i=[];for(let e=0;e<r.length;e++){var m=r[e].getAttribute("data-anum"),d=r[e].getAttribute("data-atext");i.push({anum:parseInt(m),atext:await decrypt(d,lobby_key)})}var l=parseInt(s),s=game.meta.qTypes.getQuestionType(l);o.innerHTML=n,c.innerHTML=(e+1).toString(),u.innerHTML=a,g.innerHTML=s.description,y.style.width=Math.round(100-100*M()/game.meta.timePerQuestion)+"%",v(l,i)}function v(n,s){switch(n){case 1:l.innerHTML="";let e=document.getElementById("qtype_temp1").cloneNode(!0);e.id="qtype_1_1",e.classList.remove("template"),e.innerHTML.replace("temp1","1_1"),l.appendChild(e);break;case 2:l.innerHTML="";for(let a=0;a<s.length;a++){var r=s[a].anum,i=s[a].atext;let e=document.getElementById("qtype_temp2").cloneNode(!0);e.id="qtype_2_"+a,e.classList.remove("template"),e.innerHTML.replace("temp2","2_"+a),l.appendChild(e);let t=document.getElementById("answer_2_"+a),n=document.getElementById("answerLabel_2_"+a);t.value=r,n.innerHTML=i}break;case 3:l.innerHTML="";for(let a=0;a<s.length;a++){var m=s[a].anum,d=s[a].atext;let e=document.getElementById("qtype_temp3").cloneNode(!0);e.id="qtype_3_"+a,e.classList.remove("template"),e.innerHTML.replace("temp3","3_"+a),l.appendChild(e);let t=document.getElementById("answer_3_"+a),n=document.getElementById("answerLabel_3_"+a);t.value=m,n.innerHTML=d}break;case 4:l.innerHTML="";let t=document.getElementById("qtype_temp4").cloneNode(!0);t.id="qtype_4_1",t.classList.remove("template"),t.innerHTML.replace("temp4","4_1"),l.appendChild(t)}}async function f(e="",t={}){const n=await fetch(e,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});return n.json()}function T(){var e=Math.abs(game.meta.timeStarted-d()),t=game.meta.timePerQuestion+15;return Math.floor(e/t)}function E(){var e=Math.abs(game.meta.timeStarted-d()),t=game.meta.timePerQuestion;return e%(game.meta.timePerQuestion+15)<t}function M(){return Math.abs(game.meta.timeStarted-d())}function _(e=""){f(base_url+"/game/"+lobby_key,{lobbyAuth:lobby_auth,qno:T()+1,answer:e}).then(e=>{let t=document.getElementById("myResult");t.classList.remove("text-success"),t.classList.remove("text-danger"),e.lastSubmissionCorrect?(t.classList.add("text-success"),t.innerHTML="Korrekte Antwort!"):(t.classList.add("text-danger"),t.innerHTML="Falsche Antwort!");let n=document.getElementById("myAddition"),a=document.getElementById("myStreak"),s=document.getElementById("myScore");n.innerHTML=e.addition,a.innerHTML=e.streak,s.innerHTML=e.score})}function I(){var i=Object.keys(game.gamedata);let m=document.getElementById("overallResult");m.innerHTML="";for(let r=0;r<i.length;r++)if(i[r]!==first_name){var d=game.gamedata[i[r]];let e=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("td"),a=document.createElement("td"),s=document.createElement("td");d.lastSubmissionCorrect?e.classList.add("table-success"):e.classList.add("table-danger"),n.classList.add("text-center"),a.classList.add("text-center"),s.classList.add("text-center"),t.innerHTML=i[r],n.innerHTML=d.addition,a.innerHTML=d.streak,s.innerHTML=d.score,e.appendChild(t),e.appendChild(n),e.appendChild(a),e.appendChild(s),m.appendChild(e)}l.classList.add("invisible"),r.classList.remove("invisible")}function B(){l.classList.remove("invisible"),r.classList.add("invisible")}function H(){fetch(base_url+"/game/"+lobby_key).then(e=>e.json().then(n=>{for(let t=0;t<n.length;t++){var a=n[t];let e=Object.assign(playerScoreTemplate,game.playerScores[a.name]);e.streak=a.streak,e.score=a.score,e.addition=a.addition,game.playerScores[a.name]=e}I()}))}s.addEventListener("click",()=>{if(s.disabled=!0,!game.lastSubmitted){game.lastSubmitted=!0;let t=[];var n=document.getElementsByName("answer");for(let e=0;e<n;e++)!n.checked&&1!==n.length||t.push(n.value);_(t)}});